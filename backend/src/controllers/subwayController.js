// backend/controllers/subwayController.js

const { createSubwayAPIClient, parseSubwayResponse } = require('../config/subwayAPI');


class SubwayController {
  constructor() {
    this.apiClient = createSubwayAPIClient();
  }

  async getRealtimeArrival(req, res) {
    try {
      const { stationName } = req.params;
      const { lineNumber } = req.query;

      // ìž…ë ¥ ê²€ì¦
      if (!stationName) {
        return res.status(400).json({
          success: false,
          message: 'ì—­ëª…ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”.'
        });
      }


      // API í˜¸ì¶œ URL ê²½ë¡œ ìˆ˜ì • (API ë¬¸ì„œ ê¸°ì¤€)
      const encodedStationName = encodeURIComponent(stationName);
      const endpoint = `/${process.env.SEOUL_SUBWAY_API_KEY}/json/realtimeStationArrival/1/20/${encodedStationName}`;
      
      console.log(`[Controller] API í˜¸ì¶œ ì‹œìž‘: ${endpoint}`);
      
      const response = await this.apiClient.get(endpoint);
      console.log(`[Controller] API í˜¸ì¶œ ì™„ë£Œ, ë°ì´í„° íŒŒì‹± ì‹œìž‘`);

      // ë°ì´í„° íŒŒì‹±
      let arrivalData = parseSubwayResponse(response);
      console.log(`[Controller] íŒŒì‹± ì™„ë£Œ, ì´ ${arrivalData.length}ê°œ ì—´ì°¨ ì •ë³´`);

      // íŠ¹ì • í˜¸ì„  í•„í„°ë§
      if (lineNumber) {
        console.log(`[Controller] í˜¸ì„  í•„í„°ë§: ${lineNumber}`);
        const beforeFilter = arrivalData.length;
        arrivalData = arrivalData.filter(train => 
          train.lineName === lineNumber || train.lineNumber === lineNumber
        );
        console.log(`[Controller] í•„í„°ë§ ê²°ê³¼: ${beforeFilter} -> ${arrivalData.length}ê°œ`);
      }

      // ë°©í–¥ë³„ë¡œ ê·¸ë£¹í™” ë° ì •ë ¬
      const groupedData = this.groupAndSortTrains(arrivalData);
      console.log(`[Controller] ê·¸ë£¹í™” ì™„ë£Œ, ${Object.keys(groupedData).length}ê°œ ë°©í–¥`);


      res.json({
        success: true,
        data: groupedData,
        cached: false,
        timestamp: new Date().toISOString(),
        count: arrivalData.length,
        stationName,
        lineNumber: lineNumber || null
      });

    } catch (error) {
      console.error('[Controller] ì§€í•˜ì²  API ì˜¤ë¥˜:', error);
      console.error('[Controller] ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
      
      // ë” êµ¬ì²´ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€
      let statusCode = 500;
      let message = 'ì§€í•˜ì²  ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      
      if (error.message.includes('API í˜¸ì¶œ í•œë„')) {
        statusCode = 429;
        message = error.message;
      } else if (error.message.includes('API ì˜¤ë¥˜') || error.message.includes('ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤')) {
        statusCode = 400;
        message = 'í•´ë‹¹ ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì—­ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
      } else if (error.message.includes('timeout')) {
        statusCode = 408;
        message = 'API ìš”ì²­ì´ ì‹œê°„ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ìž ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
      } else if (error.code === 'ECONNREFUSED' || error.code === 'ENOTFOUND') {
        statusCode = 503;
        message = 'ì„œìš¸ì‹œ ì§€í•˜ì²  API ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      }

      res.status(statusCode).json({
        success: false,
        message,
        stationName: req.params.stationName,
        timestamp: new Date().toISOString(),
        error: process.env.NODE_ENV === 'development' ? {
          message: error.message,
          code: error.code,
          status: error.response?.status
        } : undefined
      });
    }
  }

  // ì§€í•˜ì²  ë…¸ì„  ëª©ë¡ ì¡°íšŒ (ê¸°ì¡´ê³¼ ë™ì¼)
  async getSubwayLines(req, res) {
  try {
    const lines = [
      // ê¸°ë³¸ 1-9í˜¸ì„ 
      { id: '1001', name: '1í˜¸ì„ ', color: '#0052A4' },
      { id: '1002', name: '2í˜¸ì„ ', color: '#00A84D' },
      { id: '1003', name: '3í˜¸ì„ ', color: '#EF7C1C' },
      { id: '1004', name: '4í˜¸ì„ ', color: '#00A5DE' },
      { id: '1005', name: '5í˜¸ì„ ', color: '#996CAC' },
      { id: '1006', name: '6í˜¸ì„ ', color: '#CD7C2F' },
      { id: '1007', name: '7í˜¸ì„ ', color: '#747F00' },
      { id: '1008', name: '8í˜¸ì„ ', color: '#E6186C' },
      { id: '1009', name: '9í˜¸ì„ ', color: '#BDB092' },
      
      // ê´‘ì—­ì „ì² 
      { id: '1063', name: 'ê²½ì˜ì¤‘ì•™ì„ ', color: '#77C4A3' },
      { id: '1067', name: 'ê²½ì¶˜ì„ ', color: '#178C72' },
      { id: '1075', name: 'ìˆ˜ì¸ë¶„ë‹¹ì„ ', color: '#FABE00' },
      
      // ê³µí•­/íŠ¹ìˆ˜ ë…¸ì„ 
      { id: '1065', name: 'ê³µí•­ì² ë„', color: '#0090D2' },
      { id: '1077', name: 'ì‹ ë¶„ë‹¹ì„ ', color: '#D4003B' },
      { id: '1092', name: 'ìš°ì´ì‹ ì„¤ì„ ', color: '#B7C452' },
      
      // ê¸°íƒ€ ë…¸ì„ 
      { id: 'GTX-A', name: 'GTX-A', color: '#8B4513' },
      { id: 'ê²½ê°•ì„ ', name: 'ê²½ê°•ì„ ', color: '#0C8E72' },
      { id: 'ì„œí•´ì„ ', name: 'ì„œí•´ì„ ', color: '#8B008B' },
      { id: 'ì‹ ë¦¼ì„ ', name: 'ì‹ ë¦¼ì„ ', color: '#6495ED' }
    ];

    res.json({
      success: true,
      data: lines,
      count: lines.length,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('[Controller] ë…¸ì„  ì •ë³´ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      message: 'ë…¸ì„  ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    });
  }
}

  // ì—­ ëª©ë¡ì„ ë” ë§Žì´ ì¶”ê°€
async getStationsByLine(req, res) {
  try {
    const { lineNumber } = req.params;
    
    // ðŸ”¥ ì‹¤ì œ ì„œìš¸ì‹œ ë°ì´í„° ê¸°ë°˜ ì—­ ëª©ë¡ (ì—‘ì…€ì—ì„œ ì¶”ì¶œ) - ì „ì²´ 19ê°œ ë…¸ì„ 
    const stationMap = {
      '1í˜¸ì„ ': ['ì†Œìš”ì‚°', 'ë™ë‘ì²œ', 'ë³´ì‚°', 'ë™ë‘ì²œì¤‘ì•™', 'ì§€í–‰', 'ë•ì •', 'ë•ê³„', 'ì–‘ì£¼', 'ë…¹ì–‘', 'ê°€ëŠ¥', 'ì˜ì •ë¶€', 'íšŒë£¡', 'ë§ì›”ì‚¬', 'ë„ë´‰ì‚°', 'ë„ë´‰', 'ë°©í•™', 'ì°½ë™', 'ë…¹ì²œ', 'ì›”ê³„', 'ê´‘ìš´ëŒ€', 'ì„ê³„', 'ì‹ ì´ë¬¸', 'ì™¸ëŒ€ì•ž', 'íšŒê¸°', 'ì²­ëŸ‰ë¦¬', 'ì œê¸°ë™', 'ì‹ ì„¤ë™', 'ë™ë¬˜ì•ž', 'ë™ëŒ€ë¬¸', 'ì¢…ë¡œ5ê°€', 'ì¢…ë¡œ3ê°€', 'ì¢…ê°', 'ì‹œì²­', 'ì„œìš¸', 'ë‚¨ì˜', 'ìš©ì‚°', 'ë…¸ëŸ‰ì§„', 'ëŒ€ë°©', 'ì‹ ê¸¸', 'ì˜ë“±í¬', 'ì‹ ë„ë¦¼', 'êµ¬ë¡œ', 'êµ¬ì¼', 'ê°œë´‰', 'ì˜¤ë¥˜ë™', 'ì˜¨ìˆ˜', 'ì—­ê³¡', 'ì†Œì‚¬', 'ë¶€ì²œ', 'ì¤‘ë™', 'ì†¡ë‚´', 'ë¶€ê°œ', 'ë¶€í‰', 'ë°±ìš´', 'ë™ì•”', 'ê°„ì„', 'ì£¼ì•ˆ', 'ë„í™”', 'ì œë¬¼í¬', 'ë„ì›', 'ë™ì¸ì²œ', 'ì¸ì²œ', 'ì²­ì‚°', 'ì „ê³¡', 'ì—°ì²œ', 'ê´‘ëª…', 'ê°€ì‚°ë””ì§€í„¸ë‹¨ì§€', 'ë…ì‚°', 'ê¸ˆì²œêµ¬ì²­', 'ì„ìˆ˜', 'ê´€ì•…', 'ì•ˆì–‘', 'ëª…í•™', 'ê¸ˆì •', 'êµ°í¬', 'ë‹¹ì •', 'ì˜ì™•', 'ì„±ê· ê´€ëŒ€', 'í™”ì„œ', 'ìˆ˜ì›', 'ì„¸ë¥˜', 'ë³‘ì ', 'ì„¸ë§ˆ', 'ì˜¤ì‚°ëŒ€', 'ì˜¤ì‚°', 'ì§„ìœ„', 'ì†¡íƒ„', 'ì„œì •ë¦¬', 'ì§€ì œ', 'í‰íƒ', 'ì„±í™˜', 'ì§ì‚°', 'ë‘ì •', 'ì²œì•ˆ', 'ë´‰ëª…', 'ìŒìš©(ë‚˜ì‚¬ë ›ëŒ€)', 'ì•„ì‚°', 'íƒ•ì •', 'ë°°ë°©', 'ì˜¨ì–‘ì˜¨ì²œ', 'ì‹ ì°½', 'ì„œë™íƒ„'],
      '2í˜¸ì„ ': ['ì‹œì²­', 'ì„ì§€ë¡œìž…êµ¬', 'ì„ì§€ë¡œ3ê°€', 'ì„ì§€ë¡œ4ê°€', 'ë™ëŒ€ë¬¸ì—­ì‚¬ë¬¸í™”ê³µì›', 'ì‹ ë‹¹', 'ìƒì™•ì‹­ë¦¬', 'ì™•ì‹­ë¦¬', 'í•œì–‘ëŒ€', 'ëšì„¬', 'ì„±ìˆ˜', 'ê±´ëŒ€ìž…êµ¬', 'êµ¬ì˜', 'ê°•ë³€', 'ìž ì‹¤ë‚˜ë£¨', 'ìž ì‹¤', 'ìž ì‹¤ìƒˆë‚´', 'ì¢…í•©ìš´ë™ìž¥', 'ì‚¼ì„±', 'ì„ ë¦‰', 'ì—­ì‚¼', 'ê°•ë‚¨', 'êµëŒ€', 'ì„œì´ˆ', 'ë°©ë°°', 'ì‚¬ë‹¹', 'ë‚™ì„±ëŒ€', 'ì„œìš¸ëŒ€ìž…êµ¬', 'ë´‰ì²œ', 'ì‹ ë¦¼', 'ì‹ ëŒ€ë°©', 'êµ¬ë¡œë””ì§€í„¸ë‹¨ì§€', 'ëŒ€ë¦¼', 'ì‹ ë„ë¦¼', 'ë¬¸ëž˜', 'ì˜ë“±í¬êµ¬ì²­', 'ë‹¹ì‚°', 'í•©ì •', 'í™ëŒ€ìž…êµ¬', 'ì‹ ì´Œ', 'ì´ëŒ€', 'ì•„í˜„', 'ì¶©ì •ë¡œ', 'ìš©ë‹µ', 'ì‹ ë‹µ', 'ìš©ë‘', 'ì‹ ì„¤ë™', 'ë„ë¦¼ì²œ', 'ì–‘ì²œêµ¬ì²­', 'ì‹ ì •ë„¤ê±°ë¦¬', 'ê¹Œì¹˜ì‚°'],
      '3í˜¸ì„ ': ['ëŒ€í™”', 'ì£¼ì—½', 'ì •ë°œì‚°', 'ë§ˆë‘', 'ë°±ì„', 'ëŒ€ê³¡', 'í™”ì •', 'ì›ë‹¹', 'ì›í¥', 'ì‚¼ì†¡', 'ì§€ì¶•', 'êµ¬íŒŒë°œ', 'ì—°ì‹ ë‚´', 'ë¶ˆê´‘', 'ë…¹ë²ˆ', 'í™ì œ', 'ë¬´ì•…ìž¬', 'ë…ë¦½ë¬¸', 'ê²½ë³µê¶', 'ì•ˆêµ­', 'ì¢…ë¡œ3ê°€', 'ì„ì§€ë¡œ3ê°€', 'ì¶©ë¬´ë¡œ', 'ë™ëŒ€ìž…êµ¬', 'ì•½ìˆ˜', 'ê¸ˆê³ ', 'ì˜¥ìˆ˜', 'ì••êµ¬ì •', 'ì‹ ì‚¬', 'ìž ì›', 'ê³ ì†í„°ë¯¸ë„', 'êµëŒ€', 'ë‚¨ë¶€í„°ë¯¸ë„', 'ì–‘ìž¬', 'ë§¤ë´‰', 'ë„ê³¡', 'ëŒ€ì¹˜', 'í•™ì—¬ìš¸', 'ëŒ€ì²­', 'ì¼ì›', 'ìˆ˜ì„œ', 'ê°€ë½ì‹œìž¥', 'ê²½ì°°ë³‘ì›', 'ì˜¤ê¸ˆ'],
      '4í˜¸ì„ ': ['ë¶ˆì•”ì‚°', 'ìƒê³„', 'ë…¸ì›', 'ì°½ë™', 'ìŒë¬¸', 'ìˆ˜ìœ ', 'ë¯¸ì•„', 'ë¯¸ì•„ì‚¬ê±°ë¦¬', 'ê¸¸ìŒ', 'ì„±ì‹ ì—¬ëŒ€ìž…êµ¬', 'í•œì„±ëŒ€ìž…êµ¬', 'í˜œí™”', 'ë™ëŒ€ë¬¸', 'ë™ëŒ€ë¬¸ì—­ì‚¬ë¬¸í™”ê³µì›', 'ì¶©ë¬´ë¡œ', 'ëª…ë™', 'íšŒí˜„', 'ì„œìš¸', 'ìˆ™ëŒ€ìž…êµ¬', 'ì‚¼ê°ì§€', 'ì‹ ìš©ì‚°', 'ì´ì´Œ', 'ë™ìž‘', 'ì´ì‹ ëŒ€ìž…êµ¬(ì´ìˆ˜)', 'ì‚¬ë‹¹', 'ë‚¨íƒœë ¹', 'ì„ ë°”ìœ„', 'ê²½ë§ˆê³µì›', 'ëŒ€ê³µì›', 'ê³¼ì²œ', 'ì •ë¶€ê³¼ì²œì²­ì‚¬', 'ì¸ë•ì›', 'í‰ì´Œ', 'ë²”ê³„', 'ê¸ˆì •', 'ì‚°ë³¸', 'ìˆ˜ë¦¬ì‚°', 'ëŒ€ì•¼ë¯¸', 'ë°˜ì›”', 'ìƒë¡ìˆ˜', 'í•œëŒ€ì•ž', 'ì¤‘ì•™', 'ê³ ìž”', 'ì´ˆì§€', 'ì•ˆì‚°', 'ì‹ ê¸¸ì˜¨ì²œ', 'ì •ì™•', 'ì˜¤ì´ë„'],
      '5í˜¸ì„ ': ['ë°©í™”', 'ê°œí™”ì‚°', 'ê¹€í¬ê³µí•­', 'ì†¡ì •', 'ë§ˆê³¡', 'ë°œì‚°', 'ìš°ìž¥ì‚°', 'í™”ê³¡', 'ê¹Œì¹˜ì‚°', 'ì‹ ì •(ì€í–‰ì •)', 'ëª©ë™', 'ì˜¤ëª©êµ(ëª©ë™ìš´ë™ìž¥ì•ž)', 'ì–‘í‰', 'ì˜ë“±í¬êµ¬ì²­', 'ì˜ë“±í¬ì‹œìž¥', 'ì‹ ê¸¸', 'ì—¬ì˜ë„', 'ì—¬ì˜ë‚˜ë£¨', 'ë§ˆí¬', 'ê³µë•', 'ì• ì˜¤ê°œ', 'ì¶©ì •ë¡œ', 'ì„œëŒ€ë¬¸', 'ê´‘í™”ë¬¸', 'ì¢…ë¡œ3ê°€', 'ì„ì§€ë¡œ4ê°€', 'ë™ëŒ€ë¬¸ì—­ì‚¬ë¬¸í™”ê³µì›', 'ì²­êµ¬', 'ì‹ ê¸ˆê³ ', 'í–‰ë‹¹', 'ì™•ì‹­ë¦¬', 'ë§ˆìž¥', 'ë‹µì‹­ë¦¬', 'ìž¥í•œí‰', 'êµ°ìž(ëŠ¥ë™)', 'ì•„ì°¨ì‚°(ì–´ë¦°ì´ëŒ€ê³µì›í›„ë¬¸)', 'ê´‘ë‚˜ë£¨(ìž¥ì‹ ëŒ€)', 'ì²œí˜¸(í’ë‚©í† ì„±)', 'ê°•ë™', 'ê¸¸ë™', 'êµ½ì€ë‹¤ë¦¬(ê°•ë™êµ¬ë¯¼íšŒê´€ì•ž)', 'ëª…ì¼', 'ê³ ë•', 'ìƒì¼ë™', 'ê°•ì¼', 'ë¯¸ì‚¬', 'í•˜ë‚¨í’ì‚°', 'í•˜ë‚¨ì‹œì²­', 'í•˜ë‚¨ê²€ë‹¨ì‚°', 'ë‘”ì´Œë™', 'ì˜¬ë¦¼í”½ê³µì›(í•œêµ­ì²´ëŒ€)', 'ë°©ì´', 'ì˜¤ê¸ˆ', 'ê°œë¡±', 'ê±°ì—¬', 'ë§ˆì²œ'],
      '6í˜¸ì„ ': ['ì‘ì•”ìˆœí™˜(ìƒì„ )', 'ì—­ì´Œ', 'ë¶ˆê´‘', 'ë…ë°”ìœ„', 'ì—°ì‹ ë‚´', 'êµ¬ì‚°', 'ìƒˆì ˆ(ì‹ ì‚¬)', 'ì¦ì‚°(ëª…ì§€ëŒ€ì•ž)', 'ë””ì§€í„¸ë¯¸ë””ì–´ì‹œí‹°', 'ì›”ë“œì»µê²½ê¸°ìž¥(ì„±ì‚°)', 'ë§ˆí¬êµ¬ì²­', 'ë§ì›', 'í•©ì •', 'ìƒìˆ˜', 'ê´‘í¥ì°½', 'ëŒ€í¥(ì„œê°•ëŒ€ì•ž)', 'ê³µë•', 'íš¨ì°½ê³µì›ì•ž', 'ì‚¼ê°ì§€', 'ë…¹ì‚¬í‰', 'ì´íƒœì›', 'í•œê°•ì§„', 'ë²„í‹°ê³ ê°œ', 'ì•½ìˆ˜', 'ì²­êµ¬', 'ì‹ ë‹¹', 'ë™ë¬˜ì•ž', 'ì°½ì‹ ', 'ë³´ë¬¸', 'ì•ˆì•”(ê³ ëŒ€ë³‘ì›ì•ž)', 'ê³ ë ¤ëŒ€', 'ì›”ê³¡(ë™ë•ì—¬ëŒ€)', 'ìƒì›”ê³¡(í•œêµ­ê³¼í•™ê¸°ìˆ ì—°êµ¬ì›)', 'ëŒê³¶ì´', 'ì„ê³„', 'íƒœë¦‰ìž…êµ¬', 'í™”ëž‘ëŒ€(ì„œìš¸ì—¬ëŒ€ìž…êµ¬)', 'ë´‰í™”ì‚°', 'ì‹ ë‚´'],
      '7í˜¸ì„ ': ['ìž¥ì•”', 'ë„ë´‰ì‚°', 'ìˆ˜ë½ì‚°', 'ë§ˆë“¤', 'ë…¸ì›', 'ì¤‘ê³„', 'í•˜ê³„', 'ê³µë¦‰(ì„œìš¸ì‚°ì—…ëŒ€ìž…êµ¬)', 'íƒœë¦‰ìž…êµ¬', 'ë¨¹ê³¨', 'ì¤‘í™”', 'ìƒë´‰', 'ë©´ëª©', 'ì‚¬ê°€ì •', 'ìš©ë§ˆì‚°', 'ì¤‘ê³¡', 'êµ°ìž(ëŠ¥ë™)', 'ì–´ë¦°ì´ëŒ€ê³µì›(ì„¸ì¢…ëŒ€)', 'ê±´ëŒ€ìž…êµ¬', 'ëšì„¬ìœ ì›ì§€', 'ì²­ë‹´', 'ê°•ë‚¨êµ¬ì²­', 'í•™ë™', 'ë…¼í˜„', 'ë°˜í¬', 'ê³ ì†í„°ë¯¸ë„', 'ë‚´ë°©', 'ì´ì‹ ëŒ€ìž…êµ¬(ì´ìˆ˜)', 'ë‚¨ì„±', 'ìˆ­ì‹¤ëŒ€ìž…êµ¬(ì‚´í”¼ìž¬)', 'ìƒë„(ì¤‘ì•™ëŒ€ì•ž)', 'ìž¥ìŠ¹ë°°ê¸°', 'ì‹ ëŒ€ë°©ì‚¼ê±°ë¦¬', 'ë³´ë¼ë§¤', 'ì‹ í’', 'ëŒ€ë¦¼', 'ë‚¨êµ¬ë¡œ', 'ê°€ì‚°ë””ì§€í„¸ë‹¨ì§€', 'ì² ì‚°', 'ê´‘ëª…ì‚¬ê±°ë¦¬', 'ì²œì™•', 'ì˜¨ìˆ˜', 'ê¹Œì¹˜ìš¸', 'ë¶€ì²œì¢…í•©ìš´ë™ìž¥', 'ì¶˜ì˜', 'ì‹ ì¤‘ë™', 'ë¶€ì²œì‹œì²­', 'ìƒë™', 'ì‚¼ì‚°ì²´ìœ¡ê´€', 'êµ´í¬ì²œ', 'ë¶€í‰êµ¬ì²­', 'ì‚°ê³¡', 'ì„ë‚¨'],
      '8í˜¸ì„ ': ['ë³„ë‚´', 'ë‹¤ì‚°', 'ë™êµ¬ë¦‰', 'êµ¬ë¦¬', 'ìž¥ìží˜¸ìˆ˜ê³µì›', 'ì•”ì‚¬ì—­ì‚¬ê³µì›', 'ì•”ì‚¬', 'ì²œí˜¸(í’ë‚©í† ì„±)', 'ê°•ë™êµ¬ì²­', 'ëª½ì´Œí† ì„±(í‰í™”ì˜ë¬¸)', 'ìž ì‹¤', 'ì„ì´Œ', 'ì†¡íŒŒ', 'ê°€ë½ì‹œìž¥', 'ë¬¸ì •', 'ìž¥ì§€', 'ë³µì •', 'ë‚¨ìœ„ë¡€', 'ì‚°ì„±', 'ë‚¨í•œì‚°ì„±ìž…êµ¬(ì„±ë‚¨ë²•ì›,ê²€ì°°ì²­)', 'ë‹¨ëŒ€ì˜¤ê±°ë¦¬', 'ì‹ í¥', 'ìˆ˜ì§„', 'ëª¨ëž€'],
      '9í˜¸ì„ ': ['ê°œí™”', 'ê¹€í¬ê³µí•­', 'ê³µí•­ì‹œìž¥', 'ì‹ ë°©í™”', 'ë§ˆê³¡ë‚˜ë£¨', 'ì–‘ì²œí–¥êµ', 'ê°€ì–‘', 'ì¦ë¯¸', 'ë“±ì´Œ', 'ì—¼ì°½', 'ì‹ ëª©ë™', 'ì„ ìœ ë„', 'ë‹¹ì‚°', 'êµ­íšŒì˜ì‚¬ë‹¹', 'ì—¬ì˜ë„', 'ìƒ›ê°•', 'ë…¸ëŸ‰ì§„', 'ë…¸ë“¤', 'í‘ì„', 'ë™ìž‘', 'êµ¬ë°˜í¬', 'ì‹ ë°˜í¬', 'ê³ ì†í„°ë¯¸ë„', 'ì‚¬í‰', 'ì‹ ë…¼í˜„', 'ì–¸ì£¼', 'ì„ ì •ë¦‰', 'ì‚¼ì„±ì¤‘ì•™', 'ë´‰ì€ì‚¬', 'ì¢…í•©ìš´ë™ìž¥', 'ì‚¼ì „', 'ì„ì´Œê³ ë¶„', 'ì„ì´Œ', 'ì†¡íŒŒë‚˜ë£¨', 'í•œì„±ë°±ì œ', 'ì˜¬ë¦¼í”½ê³µì›', 'ë‘”ì´Œì˜¤ë¥œ', 'ì¤‘ì•™ë³´í›ˆë³‘ì›'],
      'GTX-A': ['ìš´ì •ì¤‘ì•™', 'í‚¨í…ìŠ¤', 'ëŒ€ê³¡', 'ì—°ì‹ ë‚´', 'ì„œìš¸', 'ìˆ˜ì„œ', 'ì„±ë‚¨', 'êµ¬ì„±', 'ë™íƒ„'],
      'ê²½ê°•ì„ ': ['íŒêµ', 'ì„±ë‚¨', 'ì´ë§¤', 'ì‚¼ë™', 'ê²½ê¸°ê´‘ì£¼', 'ì´ˆì›”', 'ê³¤ì§€ì•”', 'ì‹ ë‘”ë„ì˜ˆì´Œ', 'ì´ì²œ', 'ë¶€ë°œ', 'ì„¸ì¢…ì™•ë¦‰', 'ì—¬ì£¼'],
      'ê²½ì˜ì¤‘ì•™ì„ ': ['ìš©ì‚°', 'ì´ì´Œ', 'ì„œë¹™ê³ ', 'í•œë‚¨', 'ì˜¥ìˆ˜', 'ì‘ë´‰', 'ì™•ì‹­ë¦¬', 'ì²­ëŸ‰ë¦¬', 'íšŒê¸°', 'ì¤‘ëž‘', 'ìƒë´‰', 'ë§ìš°', 'ì–‘ì›', 'êµ¬ë¦¬', 'ë„ë†', 'ì–‘ì •', 'ë•ì†Œ', 'ë„ì‹¬', 'íŒ”ë‹¹', 'ìš´ê¸¸ì‚°', 'ì–‘ìˆ˜', 'ì‹ ì›', 'êµ­ìˆ˜', 'ì•„ì‹ ', 'ì˜¤ë¹ˆ', 'ì–‘í‰', 'ì›ë•', 'ìš©ë¬¸', 'ì§€í‰', 'ê³µë•', 'ì„œê°•ëŒ€', 'í™ëŒ€ìž…êµ¬', 'ê°€ì¢Œ', 'ë””ì§€í„¸ë¯¸ë””ì–´ì‹œí‹°', 'ìˆ˜ìƒ‰', 'í•œêµ­í•­ê³µëŒ€', 'ê°•ë§¤', 'í–‰ì‹ ', 'ëŠ¥ê³¡', 'ëŒ€ê³¡', 'ê³¡ì‚°', 'ë°±ë§ˆ', 'í’ì‚°', 'ì¼ì‚°', 'íƒ„í˜„', 'ì•¼ë‹¹', 'ìš´ì •', 'ê¸ˆë¦‰', 'ê¸ˆì´Œ', 'ì›”ë¡±', 'íŒŒì£¼', 'ë¬¸ì‚°', 'ìš´ì²œ', 'ìž„ì§„ê°•', 'íš¨ì°½ê³µì›ì•ž', 'ì‹ ì´Œ(ê²½ì˜ì¤‘ì•™ì„ )', 'ì„œìš¸'],
      'ê²½ì¶˜ì„ ': ['ì²­ëŸ‰ë¦¬', 'íšŒê¸°', 'ì¤‘ëž‘', 'ê´‘ìš´ëŒ€', 'ìƒë´‰', 'ë§ìš°', 'ì‹ ë‚´', 'ê°ˆë§¤', 'ë³„ë‚´', 'í‡´ê³„ì›', 'ì‚¬ë¦‰', 'ê¸ˆê³¡', 'í‰ë‚´í˜¸í‰', 'ì²œë§ˆì‚°', 'ë§ˆì„', 'ëŒ€ì„±ë¦¬', 'ì²­í‰', 'ìƒì²œ', 'ê°€í‰', 'êµ´ë´‰ì‚°', 'ë°±ì–‘ë¦¬', 'ê°•ì´Œ', 'ê¹€ìœ ì •', 'ë‚¨ì¶˜ì²œ', 'ì¶˜ì²œ'],
      'ê³µí•­ì² ë„': ['ì„œìš¸', 'ê³µë•', 'í™ëŒ€ìž…êµ¬', 'ë””ì§€í„¸ë¯¸ë””ì–´ì‹œí‹°', 'ê¹€í¬ê³µí•­', 'ê³„ì–‘', 'ê²€ì•”', 'ìš´ì„œ', 'ê³µí•­í™”ë¬¼ì²­ì‚¬', 'ì¸ì²œê³µí•­1í„°ë¯¸ë„', 'ì¸ì²œê³µí•­2í„°ë¯¸ë„', 'ë§ˆê³¡ë‚˜ë£¨', 'ì²­ë¼êµ­ì œë„ì‹œ', 'ì˜ì¢…'],
      'ì„œí•´ì„ ': ['ì¼ì‚°', 'í’ì‚°', 'ë°±ë§ˆ', 'ê³¡ì‚°', 'ëŒ€ê³¡', 'ëŠ¥ê³¡', 'ê¹€í¬ê³µí•­', 'ì›ì¢…', 'ë¶€ì²œì¢…í•©ìš´ë™ìž¥', 'ì†Œì‚¬', 'ì†Œìƒˆìš¸', 'ì‹œí¥ëŒ€ì•¼', 'ì‹ ì²œ', 'ì‹ í˜„', 'ì‹œí¥ì‹œì²­', 'ì‹œí¥ëŠ¥ê³¡', 'ë‹¬ë¯¸', 'ì„ ë¶€', 'ì´ˆì§€', 'ì‹œìš°', 'ì›ì‹œ'],
      'ìˆ˜ì¸ë¶„ë‹¹ì„ ': ['ì²­ëŸ‰ë¦¬', 'ì™•ì‹­ë¦¬', 'ì„œìš¸ìˆ²', 'ì••êµ¬ì •ë¡œë°ì˜¤', 'ê°•ë‚¨êµ¬ì²­', 'ì„ ì •ë¦‰', 'ì„ ë¦‰', 'í•œí‹°', 'ë„ê³¡', 'êµ¬ë£¡', 'ê°œí¬ë™', 'ëŒ€ëª¨ì‚°ìž…êµ¬', 'ìˆ˜ì„œ', 'ë³µì •', 'ê°€ì²œëŒ€', 'íƒœí‰', 'ëª¨ëž€', 'ì•¼íƒ‘', 'ì´ë§¤', 'ì„œí˜„', 'ìˆ˜ë‚´', 'ì •ìž', 'ë¯¸ê¸ˆ', 'ì˜¤ë¦¬', 'ì£½ì „', 'ë³´ì •', 'êµ¬ì„±', 'ì‹ ê°ˆ', 'ê¸°í¥', 'ìƒê°ˆ', 'ì²­ëª…', 'ì˜í†µ', 'ë§í¬', 'ë§¤íƒ„ê¶Œì„ ', 'ìˆ˜ì›ì‹œì²­', 'ë§¤êµ', 'ìˆ˜ì›', 'ê³ ìƒ‰', 'ì˜¤ëª©ì²œ', 'ì–´ì²œ', 'ì•¼ëª©', 'ì‚¬ë¦¬', 'í•œëŒ€ì•ž', 'ì¤‘ì•™', 'ê³ ìž”', 'ì´ˆì§€', 'ì•ˆì‚°', 'ì‹ ê¸¸ì˜¨ì²œ', 'ì •ì™•', 'ì˜¤ì´ë„', 'ë‹¬ì›”', 'ì›”ê³¶', 'ì†Œëž˜í¬êµ¬', 'ì¸ì²œë…¼í˜„', 'í˜¸êµ¬í¬', 'ë‚¨ë™ì¸ë”ìŠ¤íŒŒí¬', 'ì›ì¸ìž¬', 'ì—°ìˆ˜', 'ì†¡ë„', 'ì¸í•˜ëŒ€', 'ìˆ­ì˜', 'ì‹ í¬', 'ì¸ì²œ'],
      'ì‹ ë¦¼ì„ ': ['ìƒ›ê°•', 'ëŒ€ë°©', 'ì„œìš¸ì§€ë°©ë³‘ë¬´ì²­', 'ë³´ë¼ë§¤', 'ë³´ë¼ë§¤ê³µì›', 'ë³´ë¼ë§¤ë³‘ì›', 'ë‹¹ê³¡', 'ì‹ ë¦¼', 'ì„œì›', 'ì„œìš¸ëŒ€ë²¤ì²˜íƒ€ìš´', 'ê´€ì•…ì‚°'],
      'ì‹ ë¶„ë‹¹ì„ ': ['ì‹ ì‚¬', 'ë…¼í˜„', 'ì‹ ë…¼í˜„', 'ê°•ë‚¨', 'ì–‘ìž¬', 'ì–‘ìž¬ì‹œë¯¼ì˜ìˆ²', 'ì²­ê³„ì‚°ìž…êµ¬', 'íŒêµ', 'ì •ìž', 'ë¯¸ê¸ˆ', 'ë™ì²œ', 'ìˆ˜ì§€êµ¬ì²­', 'ì„±ë³µ', 'ìƒí˜„', 'ê´‘êµì¤‘ì•™', 'ê´‘êµ'],
      'ìš°ì´ì‹ ì„¤ì„ ': ['ë¶í•œì‚°ìš°ì´', 'ì†”ë°­ê³µì›', '4.19 ë¯¼ì£¼ë¬˜ì§€', 'ê°€ì˜¤ë¦¬', 'í™”ê³„', 'ì‚¼ì–‘', 'ì‚¼ì–‘ì‚¬ê±°ë¦¬', 'ì†”ìƒ˜', 'ë¶í•œì‚°ë³´êµ­ë¬¸', 'ì •ë¦‰', 'ì„±ì‹ ì—¬ëŒ€ìž…êµ¬', 'ë³´ë¬¸', 'ì‹ ì„¤ë™']
    };

    const stations = stationMap[lineNumber] || [];

    console.log(`[Controller] ${lineNumber} ì—­ ëª©ë¡ ì¡°íšŒ: ${stations.length}ê°œ ì—­`);

    res.json({
      success: true,
      data: stations,
      lineNumber,
      count: stations.length,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('[Controller] ì—­ ëª©ë¡ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      message: 'ì—­ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    });
  }
}

  // ë‚˜ë¨¸ì§€ ë©”ì„œë“œë“¤ì€ ê¸°ì¡´ê³¼ ë™ì¼
  async getTrainSeatInfo(req, res) {
    try {
      const { trainNumber } = req.params;

      if (!trainNumber) {
        return res.status(400).json({
          success: false,
          message: 'ì—´ì°¨ë²ˆí˜¸ë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”.'
        });
      }

      const seatInfo = this.generateMockSeatData(trainNumber);

      res.json({
        success: true,
        data: seatInfo,
        trainNumber,
        timestamp: new Date().toISOString()
      });

    } catch (error) {
      console.error('[Controller] ì¢Œì„ ì •ë³´ ì˜¤ë¥˜:', error);
      res.status(500).json({
        success: false,
        message: 'ì¢Œì„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
      });
    }
  }


  groupAndSortTrains(arrivalData) {
    console.log('[Controller] ê·¸ë£¹í™” ì‹œìž‘, ìž…ë ¥ ë°ì´í„°:', arrivalData.length);
    
    const grouped = arrivalData.reduce((acc, train) => {
      const key = `${train.lineName}_${train.direction}`;
      if (!acc[key]) {
        acc[key] = [];
      }
      acc[key].push(train);
      return acc;
    }, {});

    // ê° ê·¸ë£¹ ë‚´ì—ì„œ ë„ì°©ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬
    Object.keys(grouped).forEach(key => {
      grouped[key].sort((a, b) => {
        if (a.remainingTime === null) return 1;
        if (b.remainingTime === null) return -1;
        return a.remainingTime - b.remainingTime;
      });
    });

    console.log('[Controller] ê·¸ë£¹í™” ê²°ê³¼:', Object.keys(grouped));
    return grouped;
  }

  generateMockSeatData(trainNumber) {
    const seed = trainNumber.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
    const random = () => (seed * 9301 + 49297) % 233280 / 233280;

    const totalSeats = 48;
    const occupiedCount = Math.floor(random() * totalSeats * 0.7);
    const reservedCount = Math.floor(random() * (totalSeats - occupiedCount) * 0.3);

    const occupiedSeats = [];
    const reservedSeats = [];
    const usedSeats = new Set();

    while (occupiedSeats.length < occupiedCount) {
      const seat = Math.floor(random() * totalSeats) + 1;
      if (!usedSeats.has(seat)) {
        occupiedSeats.push(seat);
        usedSeats.add(seat);
      }
    }

    while (reservedSeats.length < reservedCount) {
      const seat = Math.floor(random() * totalSeats) + 1;
      if (!usedSeats.has(seat)) {
        reservedSeats.push(seat);
        usedSeats.add(seat);
      }
    }

    return {
      trainNumber,
      totalSeats,
      occupiedSeats: occupiedSeats.sort((a, b) => a - b),
      reservedSeats: reservedSeats.sort((a, b) => a - b),
      availableSeats: totalSeats - occupiedCount - reservedCount,
      lastUpdated: new Date().toISOString()
    };
  }
}

const subwayController = new SubwayController();

module.exports = {
  getRealtimeArrival: subwayController.getRealtimeArrival.bind(subwayController),
  getSubwayLines: subwayController.getSubwayLines.bind(subwayController),
  getStationsByLine: subwayController.getStationsByLine.bind(subwayController),
  getTrainSeatInfo: subwayController.getTrainSeatInfo.bind(subwayController)
};